<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>MoonBeam</title>
  <style>
    body, html { height: 100%; margin: 0; background: #1e1e1e; color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
    #app { display: flex; flex-direction: column; width: 100%; height: 100%; }

    #top-row { display: flex; flex: 1; overflow: hidden; }

    /* Server Sidebar */
    #server-sidebar {
      width: 72px; background: #202225; display: flex; flex-direction: column; align-items: center; padding: 12px 0; gap: 8px;
    }
    .server-icon {
      width: 48px; height: 48px; border-radius: 50%; cursor: pointer; object-fit: cover; transition: border-radius 0.2s;
    }
    .server-icon:hover { border-radius: 16px; }
    .server-icon.home { border-radius: 16px; background: #36393f; padding: 4px; }
    #create-server-btn, #join-server-btn {
      width: 48px; height: 48px; background: #36393f; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 28px; color: #3ba55c; cursor: pointer; font-weight: bold;
    }
    #create-server-btn:hover, #join-server-btn:hover {
      border-radius: 16px; background: #3ba55c; color: white;
    }

    /* Channel Sidebar */
    #channel-sidebar {
      width: 240px; background: #2f3136; display: flex; flex-direction: column;
    }
    #server-header {
      padding: 16px; font-size: 16px; font-weight: 600; border-bottom: 1px solid #202225; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;
    }
    #channels-list {
      flex: 1; overflow-y: auto; padding: 8px 0;
    }
    .channel {
      padding: 6px 16px; cursor: pointer; color: #96989d; display: flex; align-items: center;
    }
    .channel:hover { background: rgba(79,84,92,0.3); color: #fff; }
    .channel.active { background: rgba(79,84,92,0.6); color: #fff; }
    .channel.text::before { content: "# "; opacity: 0.6; }
    .channel.voice::before { content: "üîä "; opacity: 0.6; }

    /* Main Content */
    #main-content {
      flex: 1; display: flex; flex-direction: column; background: #36393f;
    }
    #chat-header {
      padding: 16px; border-bottom: 1px solid #202225; font-size: 18px; font-weight: 600;
    }
    #messages {
      flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px;
    }
    .message {
      max-width: 70%; padding: 8px 12px; background: #40444b; border-radius: 8px; align-self: flex-start; word-wrap: break-word;
    }
    .message.self {
      background: #5865f2; align-self: flex-end;
    }
    .message-author {
      font-weight: 600; font-size: 14px; margin-bottom: 4px;
    }
    .message-content {
      font-size: 15px;
    }

    #message-input {
      padding: 16px 20px; background: #40444b;
    }
    #message-input input {
      width: 100%; padding: 12px 16px; background: #40444b; border: 1px solid #202225; border-radius: 8px; color: #dcddde; font-size: 15px;
    }
    #message-input input:focus { outline: none; border-color: #00aff4; }

    /* Member Sidebar */
    #member-sidebar {
      width: 240px; background: #2f3136; padding: 16px 8px;
    }
    #member-list {
      font-style: italic; color: #96989d;
    }
    .member {
      padding: 4px 8px; display: flex; align-items: center;
    }
    .member-name { margin-left: 8px; font-size: 14px; }

    /* Bottom User Bar */
    #user-bar {
      height: 54px; background: #292b2f; display: flex; align-items: center; padding: 0 16px; border-top: 1px solid #202225;
    }
    #user-info {
      display: flex; align-items: center; flex: 1;
    }
    #user-pfp {
      width: 32px; height: 32px; border-radius: 50%; margin-right: 12px;
    }
    #user-name { font-weight: 600; font-size: 14px; }
    #user-status { font-size: 12px; color: #3ba55c; margin-left: 8px; }
    #settings-gear {
      margin-left: auto; cursor: pointer; font-size: 20px; color: #b9bbbe; padding: 8px; border-radius: 4px;
    }
    #settings-gear:hover { background: #36393f; color: white; }

    #voice-status {
      display: none; align-items: center; margin-left: auto;
    }
    #voice-status button {
      padding: 6px 12px; background: #36393f; border: none; border-radius: 4px; color: white; cursor: pointer; margin-left: 8px;
    }

    /* Auth Overlay */
    #auth-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111214; display: flex; align-items: center; justify-content: center; z-index: 100;
    }
    #auth-box {
      background: #36393f; padding: 40px; border-radius: 8px; width: 400px; box-shadow: 0 8px 32px rgba(0,0,0,0.8);
    }
    #auth-box h2 { text-align: center; margin-bottom: 32px; font-size: 24px; }
    #auth-box h3 { margin: 24px 0 12px 0; }
    #auth-box input {
      width: 100%; padding: 12px; margin: 8px 0; background: #202225; border: none; border-radius: 4px; color: white; font-size: 15px;
    }
    #auth-box button {
      width: 100%; padding: 12px; margin: 16px 0 8px; background: #5865f2; border: none; border-radius: 4px; color: white; font-size: 16px; cursor: pointer;
    }
    #auth-box button:hover { background: #4752c4; }
    .message { min-height: 24px; color: #f04747; font-size: 14px; text-align: center; }
  </style>
</head>
<body>

  <!-- Auth Overlay -->
  <div id="auth-overlay">
    <div id="auth-box">
      <h2>Welcome to MoonBeam</h2>

      <div id="signup-form">
        <h3>Create Account</h3>
        <input type="email" id="signup-email" placeholder="Email" />
        <input type="password" id="signup-password" placeholder="Password (min 6 characters)" />
        <input type="text" id="signup-username" placeholder="Choose a Username" />
        <button id="signup-btn">Sign Up</button>
        <p id="signup-message" class="message"></p>
      </div>

      <div id="login-form">
        <h3>Log In</h3>
        <input type="email" id="login-email" placeholder="Email" />
        <input type="password" id="login-password" placeholder="Password" />
        <button id="login-btn">Log In</button>
        <p id="login-message" class="message"></p>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" style="display: none;">
    <div id="top-row">
      <!-- Server Sidebar -->
      <div id="server-sidebar">
        <img src="icon.png" class="server-icon home" id="home-btn" title="Home">
        <div style="height: 2px; width: 32px; background: #4f545c; margin: 8px 0;"></div>
        <div id="server-list"></div>
        <div id="create-server-btn" title="Create Server">+</div>
        <div id="join-server-btn" title="Join Server">üîó</div>
      </div>

      <!-- Channel Sidebar -->
      <div id="channel-sidebar">
        <div id="server-header">Select a server</div>
        <div id="channels-list">
          <div class="channel">Create or join a server to get started</div>
        </div>
      </div>

      <!-- Main Chat -->
      <div id="main-content">
        <div id="chat-header">MoonBeam</div>
        <div id="messages">
          <div style="text-align: center; color: #96989d; margin-top: 50px;">
            Log in and select a server to begin
          </div>
        </div>
        <div id="message-input">
          <input type="text" id="message-input-field" placeholder="Log in to chat..." disabled>
        </div>
      </div>

      <!-- Member Sidebar -->
      <div id="member-sidebar">
        <div id="member-list">‚Äî No server selected ‚Äî</div>
      </div>
    </div>

    <!-- Bottom User Bar -->
    <div id="user-bar">
      <div id="user-info">
        <img src="icon.png" id="user-pfp">
        <div>
          <div id="user-name">Loading...</div>
          <div id="user-status">Online</div>
        </div>
      </div>

      <div id="settings-gear">‚öôÔ∏è</div>

      <div id="voice-status">
        <span style="margin-right: 12px; font-size: 14px;">üîä Voice Connected</span>
        <button id="muteBtn">Mute</button>
        <button id="deafenBtn">Deafen</button>
        <button id="pttBtn">PTT: OFF</button>
      </div>

      <button id="logoutBtn" style="background: #f04747; margin-left: 16px; padding: 6px 12px; border-radius: 4px;">Logout</button>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./renderer.js"></script>

  <script>
    const { createClient } = supabase;
    const supabaseClient = createClient(
      'https://oydqespkweytklrbmfsk.supabase.co',
      'sb_publishable_y-QjZQ2PKcqhbdQ4OAOWmQ_Z8m8f2CL'
    );
    window.supabase = supabaseClient;

    let currentUsername = '';
    let currentUserId = '';
    let currentServer = null;
    let currentChannel = null;
    let messageSubscription = null;

    // Signup
    document.getElementById('signup-btn').onclick = async () => {
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;
      const username = document.getElementById('signup-username').value.trim();

      if (!email || !password || !username) {
        document.getElementById('signup-message').textContent = 'All fields are required';
        return;
      }

      const { error } = await supabaseClient.auth.signUp({
        email,
        password,
        options: { data: { username } }
      });

      document.getElementById('signup-message').textContent = 
        error ? error.message : 'Success! Check your email to confirm, then log in.';
    };

    // Login
    document.getElementById('login-btn').onclick = async () => {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;

      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });

      if (error) {
        document.getElementById('login-message').textContent = error.message;
      } else {
        await afterAuth();
      }
    };

    // After successful login
    async function afterAuth() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      currentUserId = user.id;

      const { data: profile } = await supabaseClient
        .from('profiles')
        .select('username')
        .eq('id', user.id)
        .single();

      currentUsername = profile?.username || 'User';

      document.getElementById('user-name').textContent = currentUsername;

      document.getElementById('auth-overlay').style.display = 'none';
      document.getElementById('app').style.display = 'flex';

      document.getElementById('message-input-field').disabled = false;
      document.getElementById('message-input-field').placeholder = 'Message #general';

      await loadServers();
    }

    // Auto-login if session exists
    supabaseClient.auth.getSession().then(({ data: { session } }) => {
      if (session) afterAuth();
    });

    // Load user's servers
    async function loadServers() {
      const { data: memberships, error } = await supabaseClient
        .from('server_members')
        .select('servers(*)')
        .eq('user_id', currentUserId);

      if (error) {
        console.error('Error loading servers:', error);
        return;
      }

      const serverList = document.getElementById('server-list');
      serverList.innerHTML = '';

      if (memberships.length === 0) {
        document.getElementById('server-header').textContent = 'No servers yet';
        return;
      }

      memberships.forEach(membership => {
        const server = membership.servers;

        const img = document.createElement('img');
        img.src = 'icon.png';
        img.className = 'server-icon';
        img.title = server.name;
        img.onclick = () => selectServer(server);
        serverList.appendChild(img);
      });
    }

    // Select a server
    async function selectServer(server) {
      currentServer = server;
      document.getElementById('server-header').textContent = server.name;

      // Load channels
      const { data: channels } = await supabaseClient
        .from('channels')
        .select('*')
        .eq('server_id', server.id)
        .order('position');

      const channelsList = document.getElementById('channels-list');
      channelsList.innerHTML = '';

      if (channels.length === 0) {
        await createDefaultChannels(server.id);
        selectServer(server); // Reload channels
        return;
      }

      channels.forEach(channel => {
        const div = document.createElement('div');
        div.className = `channel ${channel.type}`;
        div.textContent = channel.name;
        div.onclick = () => selectChannel(channel);
        channelsList.appendChild(div);
      });

      // Load members
      loadMembers(server.id);

      // Auto-select first text channel
      const firstText = channels.find(ch => ch.type === 'text');
      if (firstText) selectChannel(firstText);
    }

    // Create default channels
    async function createDefaultChannels(serverId) {
      await supabaseClient.from('channels').insert([
        { server_id: serverId, name: 'general', type: 'text', position: 0 },
        { server_id: serverId, name: 'General Voice', type: 'voice', position: 1 }
      ]);
    }

    // Select a channel
    async function selectChannel(channel) {
      // Remove active class from all channels
      document.querySelectorAll('.channel').forEach(ch => ch.classList.remove('active'));
      // Add active to clicked
      event.target.classList.add('active');

      currentChannel = channel;

      const header = document.getElementById('chat-header');
      header.textContent = channel.type === 'voice' ? `üîä ${channel.name}` : `# ${channel.name}`;

      if (channel.type === 'text') {
        document.getElementById('message-input').style.display = 'block';
        document.getElementById('message-input-field').placeholder = `Message #${channel.name}`;
        await loadMessages(channel.id);
        subscribeToMessages(channel.id);
      } else {
        document.getElementById('message-input').style.display = 'none';
        document.getElementById('messages').innerHTML = '<div style="text-align: center; color: #96989d; margin-top: 50px;">Voice channel ‚Äî connect to talk (coming soon)</div>';
      }
    }

    // Load messages
    async function loadMessages(channelId) {
      const { data: messages } = await supabaseClient
        .from('messages')
        .select('*, profiles(username)')
        .eq('channel_id', channelId)
        .order('created_at', { ascending: true });

      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML = '';

      if (messages.length === 0) {
        messagesDiv.innerHTML = '<div style="text-align: center; color: #96989d;">No messages yet ‚Äî send one!</div>';
        return;
      }

      messages.forEach(msg => {
        addMessageToUI(msg);
      });

      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Add single message to UI
    function addMessageToUI(msg) {
      const messagesDiv = document.getElementById('messages');

      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${msg.user_id === currentUserId ? 'self' : ''}`;

      const authorSpan = document.createElement('div');
      authorSpan.className = 'message-author';
      authorSpan.textContent = msg.profiles?.username || 'Unknown';

      const contentSpan = document.createElement('div');
      contentSpan.className = 'message-content';
      contentSpan.textContent = msg.content;

      messageDiv.appendChild(authorSpan);
      messageDiv.appendChild(contentSpan);
      messagesDiv.appendChild(messageDiv);

      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Subscribe to new messages
    function subscribeToMessages(channelId) {
      // Unsubscribe from previous
      if (messageSubscription) {
        supabaseClient.removeChannel(messageSubscription);
      }

      messageSubscription = supabaseClient
        .channel(`public:messages:channel_id=eq.${channelId}`)
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `channel_id=eq.${channelId}` }, payload => {
          addMessageToUI(payload.new);
        })
        .subscribe();
    }

    // Send message on Enter
    document.getElementById('message-input-field').addEventListener('keydown', async (e) => {
      if (e.key === 'Enter' && currentChannel && currentChannel.type === 'text') {
        const input = e.target;
        const content = input.value.trim();
        if (!content) return;

        const { error } = await supabaseClient.from('messages').insert({
          channel_id: currentChannel.id,
          content: content
        });

        if (error) {
          console.error('Send message error:', error);
        } else {
          input.value = '';
        }
      }
    });

    // Load members (placeholder)
    async function loadMembers(serverId) {
      const { data: members } = await supabaseClient
        .from('server_members')
        .select('*, profiles(username)')
        .eq('server_id', serverId);

      const memberList = document.getElementById('member-list');
      memberList.innerHTML = '<strong>Members ‚Äî ' + (members?.length || 0) + '</strong>';

      if (members) {
        members.forEach(m => {
          const div = document.createElement('div');
          div.className = 'member';
          div.innerHTML = `<div style="width: 32px; height: 32px; background: #5865f2; border-radius: 50%;"></div><div class="member-name">${m.profiles?.username || 'User'}</div>`;
          memberList.appendChild(div);
        });
      }
    }

    // Create server
    document.getElementById('create-server-btn').onclick = async () => {
      if (!currentUsername) {
        alert('Please log in first');
        return;
      }

      const name = prompt('Enter server name:');
      if (!name) return;

      const { data: server, error } = await supabaseClient
        .from('servers')
        .insert({ name, owner_id: currentUserId })
        .select()
        .single();

      if (error) {
        alert('Error creating server: ' + error.message);
        return;
      }

      await supabaseClient.from('server_members').insert({
        server_id: server.id,
        user_id: currentUserId,
        role: 'owner'
      });

      loadServers();
      alert(`Server "${name}" created! Default channels added.`);
    };

    // Join server via invite code
    document.getElementById('join-server-btn').onclick = async () => {
      const code = prompt('Enter invite code:');
      if (!code) return;

      const { data: invite, error } = await supabaseClient
        .from('invites')
        .select('server_id')
        .eq('code', code)
        .single();

      if (error || !invite) {
        alert('Invalid or expired invite code');
        return;
      }

      const { error: joinError } = await supabaseClient.from('server_members').insert({
        server_id: invite.server_id,
        user_id: currentUserId,
        role: 'member'
      });

      if (joinError) {
        if (joinError.code === '23505') {
          alert('You are already in this server');
        } else {
          alert('Error joining server: ' + joinError.message);
        }
        return;
      }

      loadServers();
      alert('Successfully joined the server!');
    };

    // Logout
    document.getElementById('logoutBtn').onclick = async () => {
      await supabaseClient.auth.signOut();
      location.reload();
    };

    // Settings placeholder
    document.getElementById('settings-gear').onclick = () => {
      alert('Settings coming soon!');
    };
  </script>
</body>
</html>